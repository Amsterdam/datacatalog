version: "3.0"
services:

  database:
    image: postgres:9.5
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: datacatalog
      POSTGRES_USER: datacatalog
      POSTGRES_PASSWORD: datacatalog

  example:
    build:
      context: .
    depends_on:
      - database
    volumes:
      - ./examples/running/config.yml:/etc/dcatd.yml
    ports:
      - "8122:8000"
    environment:
      DB_DATABASE: datacatalog
      DB_USER: datacatalog
      DB_PASSWORD: datacatalog
      DB_HOST: database
      DB_PORT: 5432
      PUB_JWKS: >
        {
          "keys": [
              {
                "kty": "EC",
                "key_ops": [
                  "verify",
                  "sign"
                ],
                "kid": "2aedafba-8170-4064-b704-ce92b7c89cc6",
                "crv": "P-256",
                "x": "6r8PYwqfZbq_QzoMA4tzJJsYUIIXdeyPA27qTgEJCDw=",
                "y": "Cf2clfAfFuuCB06NMfIat9ultkMyrMQO9Hd2H7O9ZVE=",
                "d": "N1vu0UQUp0vLfaNeM0EDbl4quvvL6m_ltjoAXXzkI3U="
            }
          ]
        }
    command: ["python", "-m", "datacatalog.main"]

  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    depends_on:
      - database
    environment:
      DB_DATABASE: datacatalog
      DB_USER: datacatalog
      DB_PASSWORD: datacatalog
      DB_HOST: database
      DB_PORT: 5432
    command: ["make", "test"]

  swaggerui:
    image: amsterdam/oauth2swaggerui
    ports:
      - 8686:8686
